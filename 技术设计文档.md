# 桌面语音助手技术设计文档

> **版本**：v1.0  
> **基于**：语音助手产品需求 v1.1  
> **适用对象**：架构师、前端工程师、后端工程师

---

## 1. 技术决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 目标平台 | macOS + Windows | 覆盖主流桌面用户 |
| 桌面框架 | Electron | 生态成熟、跨平台一致性好 |
| 前端框架 | React + TypeScript | 类型安全、组件化 |
| STT | OpenAI Whisper API | 准确率高、支持多语言 |
| LLM | 可配置 (Claude / OpenAI) | 灵活切换、避免供应商锁定 |
| 构建工具 | electron-builder | 成熟的打包方案 |

---

## 2. 系统架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                      UI Layer                           │
│  (React Components: Tray, Overlay, Settings)            │
├─────────────────────────────────────────────────────────┤
│                     Core Layer                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────┐  │
│  │ Hotkey   │ │  Audio   │ │  Intent  │ │   Tool     │  │
│  │ Manager  │ │ Recorder │ │ Resolver │ │  Executor  │  │
│  └──────────┘ └──────────┘ └──────────┘ └────────────┘  │
├─────────────────────────────────────────────────────────┤
│                   Service Layer                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                 │
│  │   STT    │ │   LLM    │ │  Config  │                 │
│  │ Provider │ │ Provider │ │  Store   │                 │
│  └──────────┘ └──────────┘ └──────────┘                 │
├─────────────────────────────────────────────────────────┤
│                  Platform Layer                         │
│  (Electron Main Process, Native Modules, OS APIs)       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 进程模型

```
┌─────────────────────────────────────────────────────────┐
│                   Main Process                          │
│  - 全局热键监听                                          │
│  - 系统托盘管理                                          │
│  - 工具执行 (文件/Shell/剪贴板)                          │
│  - IPC 路由                                             │
├─────────────────────────────────────────────────────────┤
│                 Renderer Process                        │
│  - React UI                                             │
│  - 音频采集 (Web Audio API)                              │
│  - 状态管理                                              │
├─────────────────────────────────────────────────────────┤
│                  Worker Thread                          │
│  - STT 请求处理                                          │
│  - LLM 请求处理                                          │
│  - 避免阻塞主线程                                        │
└─────────────────────────────────────────────────────────┘
```

### 2.3 核心数据流

```
[热键触发] 
    │
    ▼
[音频采集] ──→ AudioBuffer (PCM 16kHz)
    │
    ▼
[STT Provider] ──→ { text: string, confidence: number }
    │
    ▼
[Intent Resolver] ──→ { intent: 'dictation' | 'command', params }
    │
    ├─── dictation ───→ [type_text Tool] ──→ 插入光标位置
    │
    └─── command ─────→ [LLM Provider] ──→ [Tool Executor] ──→ 执行结果
                              │
                              ▼
                        [UI Feedback]
```

---

## 3. 模块详细设计

### 3.1 热键监听模块 (HotkeyManager)

**职责**：监听全局热键，识别触发模式，发出状态事件。

**状态机**：

```
         ┌─────────┐
         │  Idle   │◀────────────────────┐
         └────┬────┘                     │
              │ keydown                  │
              ▼                          │
         ┌─────────┐                     │
         │ Pressed │──── 300ms ────→ [长按模式: Dictation]
         └────┬────┘                     │
              │ keyup < 300ms            │
              ▼                          │
         ┌─────────┐                     │
         │ WaitDbl │──── 300ms ────→ [单击模式: Command]
         └────┬────┘                     │
              │ keydown < 300ms          │
              ▼                          │
         [双击模式: Agent] ──────────────┘
```

**接口定义**：

```typescript
interface HotkeyManager {
  register(shortcut: string): void;
  unregister(): void;
  on(event: 'trigger', callback: (mode: TriggerMode) => void): void;
  on(event: 'release', callback: () => void): void;
}

type TriggerMode = 'dictation' | 'command' | 'agent';
```

**实现方案**：
- macOS / Windows: `electron.globalShortcut` + 自定义时序检测
- 长按检测: 使用 `setTimeout` + keyup 事件配合

---

### 3.2 音频采集模块 (AudioRecorder)

**职责**：采集麦克风音频，输出标准格式音频数据。

**技术选型**：
- `navigator.mediaDevices.getUserMedia()` 获取麦克风流
- `MediaRecorder` API 录制音频
- 输出格式：WebM (Opus) 或 WAV (PCM 16kHz)

**接口定义**：

```typescript
interface AudioRecorder {
  start(): Promise<void>;
  stop(): Promise<AudioBlob>;
  getAudioLevel(): number;  // 0-1, 用于 UI 音量指示
  on(event: 'level', callback: (level: number) => void): void;
}

interface AudioBlob {
  blob: Blob;
  duration: number;  // ms
  format: 'webm' | 'wav';
}
```

**音频参数**：
- 采样率：16kHz (Whisper 推荐)
- 声道：单声道
- 格式：WebM/Opus (体积小) 或 WAV (兼容性好)

---

### 3.3 STT 模块 (STTProvider)

**职责**：将音频转换为文本。

**Provider 抽象**：

```typescript
interface STTProvider {
  transcribe(audio: AudioBlob): Promise<STTResult>;
}

interface STTResult {
  text: string;
  confidence: number;
  language: string;
  duration: number;  // 处理耗时 ms
}

// 工厂函数
function createSTTProvider(config: STTConfig): STTProvider;
```

**Whisper API 实现**：

```typescript
class WhisperProvider implements STTProvider {
  private apiKey: string;
  private model: string = 'whisper-1';
  
  async transcribe(audio: AudioBlob): Promise<STTResult> {
    const formData = new FormData();
    formData.append('file', audio.blob, 'audio.webm');
    formData.append('model', this.model);
    formData.append('language', 'zh');  // 可配置
    
    const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${this.apiKey}` },
      body: formData
    });
    
    const data = await response.json();
    return { text: data.text, confidence: 1, language: 'zh', duration: 0 };
  }
}
```

---

### 3.4 意图识别模块 (IntentResolver)

**职责**：判断用户输入是"听写"还是"指令"。

**双轨设计**：
1. **规则引擎** (优先)：快速匹配常见指令模式
2. **LLM 分类** (兜底)：处理模糊情况

**规则引擎**：

```typescript
const COMMAND_PATTERNS = [
  /^(打开|启动|运行)\s*.+/,
  /^(帮我|请|麻烦).*(写|发|创建|删除|搜索)/,
  /^(总结|翻译|润色|改写)/,
  /^(发送|发给).*(slack|邮件|微信)/i,
];

function matchRule(text: string): Intent | null {
  for (const pattern of COMMAND_PATTERNS) {
    if (pattern.test(text)) {
      return { type: 'command', confidence: 0.9 };
    }
  }
  return null;
}
```

**LLM 分类 Prompt**：

```typescript
const INTENT_CLASSIFICATION_PROMPT = `
你是一个意图分类器。判断用户输入是"听写"还是"指令"。

- dictation: 用户只是想把语音转成文字，直接输入到当前位置
- command: 用户想让系统执行某个操作

只返回 JSON: {"intent": "dictation" | "command", "confidence": 0-1}

用户输入: {text}
`;
```

**接口定义**：

```typescript
interface IntentResolver {
  resolve(text: string, mode: TriggerMode): Promise<Intent>;
}

interface Intent {
  type: 'dictation' | 'command';
  confidence: number;
  extractedParams?: Record<string, any>;  // 从文本中提取的参数
}
```

**模式与意图映射**：

| 触发模式 | 意图处理 |
|----------|----------|
| dictation (长按) | 直接输出文本，跳过意图识别 |
| command (单击) | 规则 + LLM 双轨识别 |
| agent (双击) | 强制进入 Agent 模式 |

---

### 3.5 LLM 推理模块 (LLMProvider)

**职责**：理解指令、规划工具调用、生成回复。

**Provider 抽象**：

```typescript
interface LLMProvider {
  chat(messages: Message[], tools?: ToolDefinition[]): Promise<LLMResponse>;
}

interface Message {
  role: 'system' | 'user' | 'assistant' | 'tool';
  content: string;
  tool_call_id?: string;
}

interface LLMResponse {
  content: string | null;
  tool_calls?: ToolCall[];
  usage: { prompt_tokens: number; completion_tokens: number };
}

interface ToolCall {
  id: string;
  name: string;
  arguments: Record<string, any>;
}
```

**配置切换**：

```typescript
interface LLMConfig {
  provider: 'claude' | 'openai';
  apiKey: string;
  model: string;  // claude-3-sonnet / gpt-4-turbo
  maxTokens: number;
}

function createLLMProvider(config: LLMConfig): LLMProvider {
  switch (config.provider) {
    case 'claude': return new ClaudeProvider(config);
    case 'openai': return new OpenAIProvider(config);
  }
}
```

**System Prompt**：

```typescript
const SYSTEM_PROMPT = `
你是一个桌面语音助手，可以帮助用户执行各种任务。

你可以使用以下工具：
- type_text: 在当前光标位置输入文字
- paste_text: 粘贴文字到剪贴板并模拟粘贴
- open_app: 打开应用程序
- run_shell: 执行命令行命令
- read_file / write_file: 读写文件
- send_slack: 发送 Slack 消息

规则：
1. 优先使用最简单的工具完成任务
2. 危险操作 (删除文件、执行命令) 需要明确用户确认
3. 如果不确定用户意图，先询问澄清
`;
```

---

### 3.6 工具执行层 (ToolExecutor)

**职责**：注册、管理、执行工具，处理权限控制。

**工具注册机制**：

```typescript
interface Tool {
  name: string;
  description: string;
  parameters: JSONSchema;
  permission: 'basic' | 'system' | 'dangerous';
  execute(params: Record<string, any>): Promise<ToolResult>;
}

interface ToolResult {
  success: boolean;
  data?: any;
  error?: string;
}

class ToolRegistry {
  private tools: Map<string, Tool> = new Map();
  
  register(tool: Tool): void;
  get(name: string): Tool | undefined;
  getDefinitions(): ToolDefinition[];  // 用于传给 LLM
  async execute(name: string, params: Record<string, any>): Promise<ToolResult>;
}
```

**内置工具实现**：

#### Level 1: 基础工具

```typescript
// type_text - 模拟键盘输入
const typeTextTool: Tool = {
  name: 'type_text',
  description: '在当前光标位置输入文字',
  parameters: {
    type: 'object',
    properties: {
      text: { type: 'string', description: '要输入的文字' }
    },
    required: ['text']
  },
  permission: 'basic',
  async execute({ text }) {
    // 使用 robotjs 或 nut.js 模拟键盘
    await keyboard.type(text);
    return { success: true };
  }
};

// paste_text - 通过剪贴板粘贴
const pasteTextTool: Tool = {
  name: 'paste_text',
  description: '将文字复制到剪贴板并粘贴',
  parameters: {
    type: 'object',
    properties: {
      text: { type: 'string', description: '要粘贴的文字' }
    },
    required: ['text']
  },
  permission: 'basic',
  async execute({ text }) {
    clipboard.writeText(text);
    await keyboard.pressKey(Key.LeftControl, Key.V);  // macOS 用 Command
    return { success: true };
  }
};

// read_clipboard
const readClipboardTool: Tool = {
  name: 'read_clipboard',
  description: '读取剪贴板内容',
  parameters: { type: 'object', properties: {} },
  permission: 'basic',
  async execute() {
    const text = clipboard.readText();
    return { success: true, data: text };
  }
};
```

#### Level 2: 系统操作

```typescript
// open_app
const openAppTool: Tool = {
  name: 'open_app',
  description: '打开应用程序',
  parameters: {
    type: 'object',
    properties: {
      name: { type: 'string', description: '应用名称' }
    },
    required: ['name']
  },
  permission: 'system',
  async execute({ name }) {
    if (process.platform === 'darwin') {
      await exec(`open -a "${name}"`);
    } else {
      await exec(`start "" "${name}"`);
    }
    return { success: true };
  }
};

// run_shell
const runShellTool: Tool = {
  name: 'run_shell',
  description: '执行命令行命令',
  parameters: {
    type: 'object',
    properties: {
      command: { type: 'string', description: '要执行的命令' },
      cwd: { type: 'string', description: '工作目录' }
    },
    required: ['command']
  },
  permission: 'dangerous',
  async execute({ command, cwd }) {
    const { stdout, stderr } = await exec(command, { cwd });
    return { success: true, data: { stdout, stderr } };
  }
};

// read_file / write_file / list_dir 类似实现
```

#### Level 3: 外部 API

```typescript
// send_slack
const sendSlackTool: Tool = {
  name: 'send_slack',
  description: '发送 Slack 消息',
  parameters: {
    type: 'object',
    properties: {
      channel: { type: 'string', description: '频道名或 ID' },
      message: { type: 'string', description: '消息内容' }
    },
    required: ['channel', 'message']
  },
  permission: 'system',
  async execute({ channel, message }) {
    // 调用 Slack API
    await slackClient.chat.postMessage({ channel, text: message });
    return { success: true };
  }
};
```

**权限控制**：

```typescript
interface PermissionConfig {
  basic: boolean;      // 基础工具，默认开启
  system: boolean;     // 系统操作，默认开启
  dangerous: boolean;  // 危险操作，需确认
}

class PermissionGuard {
  async check(tool: Tool): Promise<boolean> {
    if (tool.permission === 'dangerous') {
      // 弹出确认对话框
      return await dialog.confirm(`是否允许执行: ${tool.name}?`);
    }
    return this.config[tool.permission];
  }
}
```

---

### 3.7 UI 模块

**组件结构**：

```
src/renderer/
├── App.tsx                 # 根组件
├── components/
│   ├── Tray/               # 托盘菜单
│   ├── Overlay/            # 录音悬浮窗
│   │   ├── RecordingIndicator.tsx
│   │   ├── TranscriptDisplay.tsx
│   │   └── StatusBar.tsx
│   ├── Settings/           # 设置页
│   │   ├── GeneralSettings.tsx
│   │   ├── HotkeySettings.tsx
│   │   ├── ProviderSettings.tsx
│   │   └── ToolPermissions.tsx
│   └── Notification/       # 通知弹窗
├── hooks/
│   ├── useAudioRecorder.ts
│   ├── useHotkey.ts
│   └── useAppState.ts
└── store/
    └── appStore.ts         # Zustand 状态管理
```

**应用状态机**：

```typescript
type AppState = 
  | { status: 'idle' }
  | { status: 'recording'; mode: TriggerMode; duration: number }
  | { status: 'transcribing'; audio: AudioBlob }
  | { status: 'thinking'; text: string }
  | { status: 'executing'; tool: string; step: number; total: number }
  | { status: 'done'; result: string }
  | { status: 'error'; message: string };
```

**状态与 UI 映射**：

| 状态 | UI 表现 |
|------|---------|
| idle | 托盘图标正常，无悬浮窗 |
| recording | 悬浮窗显示录音动画 + 音量条 |
| transcribing | 悬浮窗显示"识别中..." |
| thinking | 悬浮窗显示文本 + "思考中..." |
| executing | 悬浮窗显示执行进度 |
| done | 悬浮窗短暂显示结果，自动消失 |
| error | 悬浮窗显示错误信息 |

---

## 4. IPC 通信设计

Electron Main Process 与 Renderer Process 之间通过 IPC 通信。

**通道定义**：

```typescript
// main -> renderer
type MainToRenderer = {
  'hotkey:trigger': { mode: TriggerMode };
  'hotkey:release': void;
  'state:update': AppState;
};

// renderer -> main
type RendererToMain = {
  'audio:transcribe': { audio: ArrayBuffer };
  'llm:chat': { messages: Message[] };
  'tool:execute': { name: string; params: Record<string, any> };
  'config:get': void;
  'config:set': { key: string; value: any };
};
```

**Preload 暴露 API**：

```typescript
// preload.ts
contextBridge.exposeInMainWorld('voiceAgent', {
  // 事件监听
  onHotkeyTrigger: (callback: (mode: TriggerMode) => void) => 
    ipcRenderer.on('hotkey:trigger', (_, mode) => callback(mode)),
  onHotkeyRelease: (callback: () => void) =>
    ipcRenderer.on('hotkey:release', () => callback()),
  
  // 主动调用
  transcribe: (audio: ArrayBuffer) => 
    ipcRenderer.invoke('audio:transcribe', { audio }),
  chat: (messages: Message[]) =>
    ipcRenderer.invoke('llm:chat', { messages }),
  executeTool: (name: string, params: Record<string, any>) =>
    ipcRenderer.invoke('tool:execute', { name, params }),
  
  // 配置
  getConfig: () => ipcRenderer.invoke('config:get'),
  setConfig: (key: string, value: any) => 
    ipcRenderer.invoke('config:set', { key, value }),
});
```

---

## 5. 配置管理

**配置文件结构**：

```typescript
interface AppConfig {
  // 热键
  hotkey: {
    shortcut: string;           // 默认 'CommandOrControl+Space'
    longPressThreshold: number; // 默认 300ms
    doublePressThreshold: number; // 默认 300ms
  };
  
  // STT
  stt: {
    provider: 'whisper';
    apiKey: string;
    language: string;  // 默认 'zh'
  };
  
  // LLM
  llm: {
    provider: 'claude' | 'openai';
    apiKey: string;
    model: string;
    maxTokens: number;
  };
  
  // 工具权限
  permissions: {
    basic: boolean;
    system: boolean;
    dangerous: boolean;
  };
  
  // UI
  ui: {
    theme: 'light' | 'dark' | 'system';
    overlayPosition: 'center' | 'top-right' | 'bottom-right';
  };
}
```

**存储方案**：
- 使用 `electron-store` 持久化到本地
- 配置文件位置：`~/.config/voice-agent/config.json`

---

## 6. 项目目录结构

```
voice-agent/
├── package.json
├── electron-builder.yml
├── tsconfig.json
├── src/
│   ├── main/                      # Electron 主进程
│   │   ├── index.ts               # 入口
│   │   ├── hotkey.ts              # 热键管理
│   │   ├── tray.ts                # 托盘
│   │   ├── ipc.ts                 # IPC 处理
│   │   └── services/
│   │       ├── stt/
│   │       │   ├── index.ts       # Provider 工厂
│   │       │   └── whisper.ts     # Whisper 实现
│   │       ├── llm/
│   │       │   ├── index.ts
│   │       │   ├── claude.ts
│   │       │   └── openai.ts
│   │       └── tools/
│   │           ├── registry.ts    # 工具注册中心
│   │           ├── basic.ts       # Level 1 工具
│   │           ├── system.ts      # Level 2 工具
│   │           └── external.ts    # Level 3 工具
│   ├── renderer/                  # React 前端
│   │   ├── index.tsx
│   │   ├── App.tsx
│   │   ├── components/
│   │   ├── hooks/
│   │   └── store/
│   ├── preload/
│   │   └── index.ts               # Preload 脚本
│   └── shared/                    # 共享类型
│       └── types.ts
├── resources/                     # 静态资源
│   ├── icon.icns
│   ├── icon.ico
│   └── tray-icon.png
└── tests/
    ├── unit/
    └── e2e/
```

---

## 7. 技术选型清单

| 类别 | 库 | 版本 | 用途 |
|------|-----|------|------|
| 框架 | electron | ^28.0.0 | 桌面应用框架 |
| 前端 | react | ^18.2.0 | UI 框架 |
| 状态管理 | zustand | ^4.4.0 | 轻量状态管理 |
| 样式 | tailwindcss | ^3.4.0 | CSS 框架 |
| 键盘模拟 | @nut-tree/nut-js | ^4.0.0 | 跨平台键盘/鼠标控制 |
| 配置存储 | electron-store | ^8.1.0 | 本地配置持久化 |
| HTTP | axios | ^1.6.0 | API 调用 |
| 构建 | electron-builder | ^24.9.0 | 打包发布 |
| 开发 | electron-vite | ^2.0.0 | 开发构建工具 |

---

## 8. 核心流程时序图

### 8.1 听写模式 (Dictation)

```
User          HotkeyManager    AudioRecorder    STTProvider    TypeTextTool
 │                 │                 │               │               │
 │─── 长按热键 ────→│                 │               │               │
 │                 │─── start() ────→│               │               │
 │                 │                 │               │               │
 │                 │    (录音中...)   │               │               │
 │                 │                 │               │               │
 │─── 松开热键 ────→│                 │               │               │
 │                 │─── stop() ─────→│               │               │
 │                 │                 │── AudioBlob ─→│               │
 │                 │                 │               │─ transcribe ─→│
 │                 │                 │               │               │
 │                 │                 │               │←── STTResult ─│
 │                 │                 │               │               │
 │                 │                 │               │──── text ────→│
 │                 │                 │               │               │─ type() ─→
 │                 │                 │               │               │
 │←──────────────── 文字已输入到光标位置 ──────────────────────────────│
```

### 8.2 指令模式 (Command)

```
User       Hotkey    Audio    STT    IntentResolver    LLM      ToolExecutor
 │           │         │       │           │            │            │
 │── 单击 ──→│         │       │           │            │            │
 │           │─ start ─→       │           │            │            │
 │           │         │       │           │            │            │
 │── 说话 ──→│ (录音)  │       │           │            │            │
 │           │         │       │           │            │            │
 │─ 停止说 ─→│─ stop ──→       │           │            │            │
 │           │         │─blob─→│           │            │            │
 │           │         │       │─ text ───→│            │            │
 │           │         │       │           │─ intent ──→│            │
 │           │         │       │           │            │─ toolCall ─→
 │           │         │       │           │            │            │─ execute
 │           │         │       │           │            │←─ result ──│
 │←─────────────────────────── 执行完成通知 ─────────────────────────│
```

---

## 9. 错误处理策略

| 场景 | 处理方式 |
|------|----------|
| 麦克风权限被拒绝 | 弹窗提示，引导用户到系统设置 |
| STT API 调用失败 | 重试 1 次，失败后提示用户检查网络 |
| LLM API 调用失败 | 重试 1 次，失败后提示 |
| 工具执行失败 | 返回错误信息给 LLM，让其决定下一步 |
| 热键冲突 | 提示用户修改热键设置 |

---

// End of Selection
```

---

## 10. 前后端分离架构

### 10.1 架构调整

将 STT 和 LLM 服务抽离为独立后端，Electron 客户端通过 HTTP 调用后端 API。

```
┌─────────────────────────────────────────────────────────────────┐
│                    Electron Desktop Client                      │
│  (UI + 热键监听 + 音频采集 + 工具执行)                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │ HTTP/HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Backend API (Docker)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  STT Service │  │  LLM Service │  │ Intent Resolver│         │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────┬───────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
    [OpenAI Whisper] [Claude API]  [OpenAI GPT]
```

**优势**：
- API Key 安全管理，不暴露给客户端
- 后端可独立扩展、缓存、限流
- 支持多客户端共享

### 10.2 后端 API 设计

**技术栈**：Node.js + Express + TypeScript

**API 端点**：

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/stt/transcribe | 语音转文字 |
| POST | /api/llm/chat | LLM 对话 |
| POST | /api/intent/resolve | 意图识别 |
| GET | /health | 健康检查 |

**请求/响应示例**：

```typescript
// POST /api/stt/transcribe
// Request: multipart/form-data, file: audio blob
// Response:
interface TranscribeResponse {
  text: string;
  confidence: number;
  language: string;
  duration: number;
}

// POST /api/llm/chat
interface ChatRequest {
  messages: Message[];
  tools?: ToolDefinition[];
  provider?: 'claude' | 'openai';
}

interface ChatResponse {
  content: string | null;
  tool_calls?: ToolCall[];
}
```

### 10.3 后端目录结构

```
backend/
├── package.json
├── tsconfig.json
├── Dockerfile
├── docker-compose.yml
├── .env.example
├── src/
│   ├── index.ts              # 入口
│   ├── routes/
│   │   ├── stt.ts
│   │   ├── llm.ts
│   │   └── intent.ts
│   ├── services/
│   │   ├── stt/
│   │   │   ├── index.ts
│   │   │   └── whisper.ts
│   │   ├── llm/
│   │   │   ├── index.ts
│   │   │   ├── claude.ts
│   │   │   └── openai.ts
│   │   └── intent/
│   │       └── resolver.ts
│   └── utils/
│       ├── config.ts
│       └── logger.ts
└── tests/
```

### 10.4 Dockerfile

```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY tsconfig.json ./
COPY src ./src
RUN npm run build

FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

COPY --from=builder /app/dist ./dist

EXPOSE 3000

USER node

CMD ["node", "dist/index.js"]
```

### 10.5 docker-compose.yml

```yaml
version: '3.8'

services:
  voice-agent-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: voice-agent-api:latest
    container_name: voice-agent-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - STT_PROVIDER=whisper
      - LLM_PROVIDER=claude
      - LLM_MODEL=claude-3-sonnet-20240229
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
```

### 10.6 环境变量

```bash
# .env.example
NODE_ENV=production
PORT=3000

# STT
STT_PROVIDER=whisper
OPENAI_API_KEY=sk-xxx

# LLM
LLM_PROVIDER=claude          # claude | openai
LLM_MODEL=claude-3-sonnet-20240229
ANTHROPIC_API_KEY=sk-ant-xxx

# 可选
LOG_LEVEL=info
CORS_ORIGIN=*
```

### 10.7 部署命令

```bash
# 构建并启动
docker-compose up -d --build

# 查看日志
docker-compose logs -f voice-agent-api

# 停止
docker-compose down

# 重启
docker-compose restart
```

### 10.8 客户端配置调整

Electron 客户端新增后端 API 地址配置：

```typescript
interface AppConfig {
  // ... 其他配置
  
  // 后端 API
  api: {
    baseUrl: string;  // 默认 'http://localhost:3000'
    timeout: number;  // 默认 30000ms
  };
}
```

---

## 11. 后续扩展点

| 版本 | 扩展内容 |
|------|----------|
| v1.5 | 本地 Whisper (whisper.cpp) 支持 |
| v1.5 | 工具执行日志可视化 |
| v2.0 | 屏幕截图理解 (Vision API) |
| v2.0 | UI 自动化 (点击、滚动) |

